<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Save EKS IP Resources with Pod SNAT - weichen's note</title><meta name=Description content="just some tech notes."><script async src="https://www.googletagmanager.com/gtag/js?id=G-4FB17VHDQ7"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4FB17VHDQ7",{anonymize_ip:!1})}</script><meta name=keywords content="aws,eks,k8s"><meta property="og:title" content="Save EKS IP Resources with Pod SNAT"><meta property="og:description" content="Background Since the company-assigned VPC is an Intranet segment, used for interfacing with the local end, from the organization&rsquo;s perspective, the VPC is not truly &lsquo;Private&rsquo;, therefore the IP quantity is still limited. Following the discovery that EKS Pods occupy ENIs, in order to solve this issue, I added another set of Private IP associated with the VPC, then performed a layer of translation via a Private NAT Gateway. This enables all EKS Pods to communicate with the local network segment through the same Intranet IP, achieving the goal of saving IP resources."><meta property="og:type" content="article"><meta property="og:url" content="https://droyuki.github.io/en/2023/06/eks-nodegroup-in-private-snet/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-10T12:06:35+08:00"><meta property="article:modified_time" content="2023-06-10T12:06:35+08:00"><meta property="og:site_name" content="weichen's note"><meta name=twitter:card content="summary"><meta name=twitter:title content="Save EKS IP Resources with Pod SNAT"><meta name=twitter:description content="Background Since the company-assigned VPC is an Intranet segment, used for interfacing with the local end, from the organization&rsquo;s perspective, the VPC is not truly &lsquo;Private&rsquo;, therefore the IP quantity is still limited. Following the discovery that EKS Pods occupy ENIs, in order to solve this issue, I added another set of Private IP associated with the VPC, then performed a layer of translation via a Private NAT Gateway. This enables all EKS Pods to communicate with the local network segment through the same Intranet IP, achieving the goal of saving IP resources."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5152060720937345" crossorigin=anonymous></script><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://droyuki.github.io/en/2023/06/eks-nodegroup-in-private-snet/><link rel=prev href=https://droyuki.github.io/en/2023/05/ip-calculator/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Save EKS IP Resources with Pod SNAT","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/droyuki.github.io\/en\/2023\/06\/eks-nodegroup-in-private-snet\/"},"genre":"posts","keywords":"aws, eks, k8s","wordcount":485,"url":"https:\/\/droyuki.github.io\/en\/2023\/06\/eks-nodegroup-in-private-snet\/","datePublished":"2023-06-10T12:06:35+08:00","dateModified":"2023-06-10T12:06:35+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"weichen"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/en/ title="weichen's note">weichen's note</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/en/posts/>Posts </a><a class=menu-item href=/en/tags/>Tags </a><a class=menu-item href=/en/categories/>Categories </a><a class=menu-item href=https://github.com/droyuki rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title="Select Language"><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/2023/06/eks-nodegroup-in-private-snet/>ÁπÅÈ´î‰∏≠Êñá</option><option value=/en/2023/06/eks-nodegroup-in-private-snet/ selected>English</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/en/ title="weichen's note">weichen's note</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/en/posts/ title>Posts</a><a class=menu-item href=/en/tags/ title>Tags</a><a class=menu-item href=/en/categories/ title>Categories</a><a class=menu-item href=https://github.com/droyuki title rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title="Select Language"><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/2023/06/eks-nodegroup-in-private-snet/>ÁπÅÈ´î‰∏≠Êñá</option><option value=/en/2023/06/eks-nodegroup-in-private-snet/ selected>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Save EKS IP Resources with Pod SNAT</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/en/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>weichen</a></span>&nbsp;<span class=post-category>included in <a href=/en/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-06-10>2023-06-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;485 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;3 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#1-add-another-private-cidr-associate-with-vpc>1. Add another Private CIDR, associate with VPC</a></li><li><a href=#2-add-subnet-and-assign-private-ip-segment>2. Add Subnet and assign Private IP segment</a></li><li><a href=#2-add-private-nat-gateway-update-route-table>2. Add Private NAT Gateway, update Route Table</a></li><li><a href=#3-customize-eks-network-settings>3. Customize EKS Network Settings</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=content id=content><h2 id=background>Background</h2><p>Since the company-assigned VPC is an Intranet segment, used for interfacing with the local end, from the organization&rsquo;s perspective, the VPC is not truly &lsquo;Private&rsquo;, therefore the IP quantity is still limited. Following the discovery that EKS Pods occupy ENIs, in order to solve this issue, I added another set of Private IP associated with the VPC, then performed a layer of translation via a Private NAT Gateway. This enables all EKS Pods to communicate with the local network segment through the same Intranet IP, achieving the goal of saving IP resources. This article will document the implementation details and related explanations.<br></p><h2 id=1-add-another-private-cidr-associate-with-vpc>1. Add another Private CIDR, associate with VPC</h2><p>Directly assign a Private IP segment, here I added a 100.64.0.0/16 segment.<br>The setting method is very simple, it can be added directly from the AWS Console, but since the team has introduced IaC, it was created with Terraform:</p><pre tabindex=0><code>resource &#34;aws_vpc_ipv4_cidr_block_association&#34; &#34;secondary_cidr&#34; {
  vpc_id     = var.vpc_id
  cidr_block = &#34;100.64.0.0/16&#34;
}
</code></pre><br><h2 id=2-add-subnet-and-assign-private-ip-segment>2. Add Subnet and assign Private IP segment</h2><p>Since my VPC is actually an Intranet IP segment, the quantity of IPs in this segment is limited, so a true Private Subnet must be created.</p><p>The creation method will not be detailed here, but if it is a Multi-AZ architecture, remember to create a Subnet in each AZ.</p><br><h2 id=2-add-private-nat-gateway-update-route-table>2. Add Private NAT Gateway, update Route Table</h2><p>Create a Private NAT Gateway in the Intranet segment, and configure the Route Table to translate the IP coming from the Private Subnet into an Intranet IP</p><pre tabindex=0><code>resource &#34;aws_nat_gateway&#34; &#34;example&#34; {
  connectivity_type = &#34;private&#34;
  subnet_id         = aws_subnet.example.id
}
</code></pre><p><br>Special attention is needed here, the default route 0.0.0.0/0 of the Private Subnet must go towards the Private NAT GW</p><table><thead><tr><th>Destination</th><th>Target</th></tr></thead><tbody><tr><td>0.0.0.0/0</td><td>nat-xxx</td></tr><tr><td>10.x.x.x/x (vpc)</td><td>local</td></tr><tr><td>100.64.0.0/16</td><td>local</td></tr></tbody></table><br><h2 id=3-customize-eks-network-settings>3. Customize EKS Network Settings</h2><p>According to the official documentation[1], firstly in the aws-node DaemonSet, set the AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG environment variable to true.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl <span class=nb>set</span> env daemonset aws-node -n kube-system <span class=nv>AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG</span><span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><p>Then, for the Private Subnet added in step 2, add ENIConfig:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt;<span class=nv>$az_1</span>.yaml <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: crd.k8s.amazonaws.com/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>kind: ENIConfig
</span></span></span><span class=line><span class=cl><span class=s>metadata: 
</span></span></span><span class=line><span class=cl><span class=s>  name: $az_1
</span></span></span><span class=line><span class=cl><span class=s>spec: 
</span></span></span><span class=line><span class=cl><span class=s>  securityGroups: 
</span></span></span><span class=line><span class=cl><span class=s>    - $cluster_security_group_id
</span></span></span><span class=line><span class=cl><span class=s>  subnet: $new_subnet_id_1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>Next is the most crucial step, setting SNAT connections for EKS Pod[2].<br>This way all Pods can connect out via the Private NAT Gateway IP.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl <span class=nb>set</span> env daemonset -n kube-system aws-node <span class=nv>AWS_VPC_K8S_CNI_EXTERNALSNAT</span><span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><br><h2 id=conclusion>Conclusion</h2><p>This article discussed how to effectively manage limited private IP resources by adding a set of private IP segments, associating them with the VPC, and creating a true Private Subnet to ensure optimal utilization of IP resources. Then, by translating via the Private NAT Gateway, all EKS Pods can communicate with the local network segment through the same internal IP address, thereby saving IP resources. Through these measures, we achieved the goal of optimizing IP resource usage while ensuring smooth internal network connections.</p><br><h2 id=references>References</h2><p>[1] <a href=https://docs.aws.amazon.com/eks/latest/userguide/cni-custom-network.html target=_blank rel="noopener noreffer">https://docs.aws.amazon.com/eks/latest/userguide/cni-custom-network.html</a></p><p>[2] <a href=https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html target=_blank rel="noopener noreffer">https://docs.aws.amazon.com/eks/latest/userguide/external-snat.html</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-06-10</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://droyuki.github.io/en/2023/06/eks-nodegroup-in-private-snet/ data-title="Save EKS IP Resources with Pod SNAT" data-hashtags=aws,eks,k8s><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://droyuki.github.io/en/2023/06/eks-nodegroup-in-private-snet/ data-hashtag=aws><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://droyuki.github.io/en/2023/06/eks-nodegroup-in-private-snet/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/en/tags/aws/>aws</a>,&nbsp;<a href=/en/tags/eks/>eks</a>,&nbsp;<a href=/en/tags/k8s/>k8s</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/en/>Home</a></span></section></div><div class=post-nav><a href=/en/2023/05/ip-calculator/ class=prev rel=prev title="IP Calculator"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>IP Calculator</a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/en/ target=_blank>weichen</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"üí¨",lightTheme:"github-light",repo:"droyuki/droyuki.github.io"}},lightgallery:!0,search:{highlightTag:null,maxResultLength:null,noResultsFound:"No results found",snippetLength:null}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4FB17VHDQ7",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4FB17VHDQ7" async></script></body></html>