<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>EKS Nodegroup IP 的配發原理 - weichen's note</title><meta name=Description content="just some tech notes."><script async src="https://www.googletagmanager.com/gtag/js?id=G-4FB17VHDQ7"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4FB17VHDQ7",{anonymize_ip:!1})}</script><meta name=keywords content="aws,eks,k8s"><meta property="og:title" content="EKS Nodegroup IP 的配發原理"><meta property="og:description" content="前情提要 因公司導入 AWS Landing Zone 架構，配發的 VPC 是 Intranet 網段，用來和地端介接 (透過 Transit Gateway)，因此 VPC 配發的 IP 數量是有限的 觀察了一下 AWS IP 的使用情況，"><meta property="og:type" content="article"><meta property="og:url" content="https://droyuki.github.io/2023/05/eks-nodegroup-ip-allocation/"><meta property="og:image" content="https://droyuki.github.io/2023/05/eks-nodegroup-ip-allocation/featured-image.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-24T20:32:58+08:00"><meta property="article:modified_time" content="2023-05-24T20:32:58+08:00"><meta property="og:site_name" content="weichen's note"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://droyuki.github.io/2023/05/eks-nodegroup-ip-allocation/featured-image.jpg"><meta name=twitter:title content="EKS Nodegroup IP 的配發原理"><meta name=twitter:description content="前情提要 因公司導入 AWS Landing Zone 架構，配發的 VPC 是 Intranet 網段，用來和地端介接 (透過 Transit Gateway)，因此 VPC 配發的 IP 數量是有限的 觀察了一下 AWS IP 的使用情況，"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5152060720937345" crossorigin=anonymous></script><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://droyuki.github.io/2023/05/eks-nodegroup-ip-allocation/><link rel=prev href=https://droyuki.github.io/2023/05/ip-calculator/><link rel=next href=https://droyuki.github.io/2023/06/eks-nodegroup-in-private-snet/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"EKS Nodegroup IP 的配發原理","inLanguage":"zh-TW","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/droyuki.github.io\/2023\/05\/eks-nodegroup-ip-allocation\/"},"genre":"posts","keywords":"aws, eks, k8s","wordcount":1507,"url":"https:\/\/droyuki.github.io\/2023\/05\/eks-nodegroup-ip-allocation\/","datePublished":"2023-05-24T20:32:58+08:00","dateModified":"2023-05-24T20:32:58+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"weichen"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="weichen's note">weichen's note</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>標籤 </a><a class=menu-item href=/categories/>分類 </a><a class=menu-item href=https://github.com/droyuki rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章標題或內容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title=選擇語言><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/2023/05/eks-nodegroup-ip-allocation/ selected>繁體中文</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="weichen's note">weichen's note</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章標題或內容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>標籤</a><a class=menu-item href=/categories/ title>分類</a><a class=menu-item href=https://github.com/droyuki title rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title=選擇語言><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/2023/05/eks-nodegroup-ip-allocation/ selected>繁體中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目錄</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">EKS Nodegroup IP 的配發原理</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>weichen</a></span>&nbsp;<span class=post-category>收錄於 <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-05-24>2023-05-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;約 1507 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;預計閱讀 4 分鐘&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目錄</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前情提要>前情提要</a></li><li><a href=#從-eks-node-group-中挑一台-ec2-instance-查看-ip-資訊>從 EKS node group 中，挑一台 EC2 Instance 查看 IP 資訊</a><ul><li><a href=#1-透過-eksctl-查看-node-group-資訊>1. 透過 <code>eksctl</code> 查看 Node Group 資訊</a></li><li><a href=#2-查看-as-group-中的-ec2-資訊>2. 查看 AS Group 中的 EC2 資訊</a></li><li><a href=#3-挑其中一台來查看-ip>3. 挑其中一台來查看 IP</a></li></ul></li><li><a href=#eks-nodegroup-ip-配發流程>EKS NodeGroup IP 配發流程</a></li><li><a href=#warm-pool-數量對於-eks-的影響>WARM POOL 數量對於 EKS 的影響</a><ul><li><a href=#warm_eni_target-除了主-eni要額外預綁定的-eni-數量>WARM_ENI_TARGET: 除了主 ENI，要額外預綁定的 ENI 數量</a></li><li><a href=#warm_ip_target-eni-中warm-pool-的-ip-數量>WARM_IP_TARGET: ENI 中，warm pool 的 IP 數量</a></li><li><a href=#minimum_ip_target-eni-要分配的最少-ip-數>MINIMUM_IP_TARGET: ENI 要分配的最少 IP 數</a></li></ul></li><li><a href=#結論>結論</a></li><li><a href=#參考資料>參考資料</a></li></ul></nav></div></div><div class=content id=content><h2 id=前情提要>前情提要</h2><p>因公司導入 AWS Landing Zone 架構，配發的 VPC 是 Intranet 網段，用來和地端介接 (透過 Transit Gateway)，因此 VPC 配發的 IP 數量是有限的</p><p>觀察了一下 AWS IP 的使用情況，發現自家的 EKS Node 是耗用 IP 的一大元兇，一個 Instance 居然用掉 30 個 IP !?</p><p>秉著研究的精神查了些資料，順手記錄一下，讓我們看下去。<br></p><h2 id=從-eks-node-group-中挑一台-ec2-instance-查看-ip-資訊>從 EKS node group 中，挑一台 EC2 Instance 查看 IP 資訊</h2><h3 id=1-透過-eksctl-查看-node-group-資訊>1. 透過 <code>eksctl</code> 查看 Node Group 資訊</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5>5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>eksctl get nodegroup --cluster &lt;cluster-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># output</span>
</span></span><span class=line><span class=cl>CLUSTER NODEGROUP STATUS CREATED MIN SIZE MAX SIZE DESIRED CAPACITY INSTANCE TYPE IMAGE ID ASG NAME TYPE
</span></span><span class=line><span class=cl>mcloud worker ACTIVE 2023-04-18T06:35:13Z <span class=m>3</span> <span class=m>6</span> <span class=m>4</span> m5a.xlarge AL2_x86_64 eks-worker-xxxx managed
</span></span></code></pre></td></tr></table></div></div><br><h3 id=2-查看-as-group-中的-ec2-資訊>2. 查看 AS Group 中的 EC2 資訊</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names eks-worker-xxxx --query <span class=s2>&#34;AutoScalingGroups[].Instances&#34;</span>
</span></span></code></pre></td></tr></table></div></div><br><h3 id=3-挑其中一台來查看-ip>3. 挑其中一台來查看 IP</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws ec2 describe-instances --instance-ids i-xxxxx --query <span class=s2>&#34;Reservations[*].Instances[*].NetworkInterfaces[]&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a class=lnlinks href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a class=lnlinks href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a class=lnlinks href=#hl-3-23>23</a>
</span><span class=lnt id=hl-3-24><a class=lnlinks href=#hl-3-24>24</a>
</span><span class=lnt id=hl-3-25><a class=lnlinks href=#hl-3-25>25</a>
</span><span class=lnt id=hl-3-26><a class=lnlinks href=#hl-3-26>26</a>
</span><span class=lnt id=hl-3-27><a class=lnlinks href=#hl-3-27>27</a>
</span><span class=lnt id=hl-3-28><a class=lnlinks href=#hl-3-28>28</a>
</span><span class=lnt id=hl-3-29><a class=lnlinks href=#hl-3-29>29</a>
</span><span class=lnt id=hl-3-30><a class=lnlinks href=#hl-3-30>30</a>
</span><span class=lnt id=hl-3-31><a class=lnlinks href=#hl-3-31>31</a>
</span><span class=lnt id=hl-3-32><a class=lnlinks href=#hl-3-32>32</a>
</span><span class=lnt id=hl-3-33><a class=lnlinks href=#hl-3-33>33</a>
</span><span class=lnt id=hl-3-34><a class=lnlinks href=#hl-3-34>34</a>
</span><span class=lnt id=hl-3-35><a class=lnlinks href=#hl-3-35>35</a>
</span><span class=lnt id=hl-3-36><a class=lnlinks href=#hl-3-36>36</a>
</span><span class=lnt id=hl-3-37><a class=lnlinks href=#hl-3-37>37</a>
</span><span class=lnt id=hl-3-38><a class=lnlinks href=#hl-3-38>38</a>
</span><span class=lnt id=hl-3-39><a class=lnlinks href=#hl-3-39>39</a>
</span><span class=lnt id=hl-3-40><a class=lnlinks href=#hl-3-40>40</a>
</span><span class=lnt id=hl-3-41><a class=lnlinks href=#hl-3-41>41</a>
</span><span class=lnt id=hl-3-42><a class=lnlinks href=#hl-3-42>42</a>
</span><span class=lnt id=hl-3-43><a class=lnlinks href=#hl-3-43>43</a>
</span><span class=lnt id=hl-3-44><a class=lnlinks href=#hl-3-44>44</a>
</span><span class=lnt id=hl-3-45><a class=lnlinks href=#hl-3-45>45</a>
</span><span class=lnt id=hl-3-46><a class=lnlinks href=#hl-3-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl> <span class=p>[</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Attachment&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;AttachTime&#34;</span><span class=p>:</span> <span class=s2>&#34;2023-04-18T06:37:00+00:00&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;AttachmentId&#34;</span><span class=p>:</span> <span class=s2>&#34;eni-attach-xxxxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;DeleteOnTermination&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;DeviceIndex&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;Status&#34;</span><span class=p>:</span> <span class=s2>&#34;attached&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;NetworkCardIndex&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>         <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Description&#34;</span><span class=p>:</span> <span class=s2>&#34;aws-K8S-i-xxxxxx5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Groups&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;GroupName&#34;</span><span class=p>:</span> <span class=s2>&#34;eks-cluster-sg-xxx-1079633432&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;GroupId&#34;</span><span class=p>:</span> <span class=s2>&#34;sg-xxxxxx&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>],</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;Ipv6Addresses&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;MacAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;0a:fd:28:xx:xx:xx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;NetworkInterfaceId&#34;</span><span class=p>:</span> <span class=s2>&#34;eni-0cf25d086xxxxxxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;OwnerId&#34;</span><span class=p>:</span> <span class=s2>&#34;xxxxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;PrivateDnsName&#34;</span><span class=p>:</span> <span class=s2>&#34;ip-10-x-x-x.ap-northeast-1.compute.internal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;PrivateIpAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;10.x.x.x&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;PrivateIpAddresses&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;Primary&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateDnsName&#34;</span><span class=p>:</span> <span class=s2>&#34;ip-10-x-x-x.ap-northeast-1.compute.internal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateIpAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;10.x.x.x&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>},</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;Primary&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateDnsName&#34;</span><span class=p>:</span> <span class=s2>&#34;ip-10-x-x-x.ap-northeast-1.compute.internal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateIpAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;10.x.x.x&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>},</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;Primary&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateDnsName&#34;</span><span class=p>:</span> <span class=s2>&#34;ip-10-x-x-x.ap-northeast-1.compute.internal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateIpAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;10.x.x.x&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>},</span>
</span></span><span class=line><span class=cl>             <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;Primary&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateDnsName&#34;</span><span class=p>:</span> <span class=s2>&#34;ip-10-x-x-x.ap-northeast-1.compute.internal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=nt>&#34;PrivateIpAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;10.x.x.x&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=err>:</span>
</span></span></code></pre></td></tr></table></div></div><p>在 Output 中，可以看到 <code>PrivateIpAddresses</code> 列出了所有 IP。這邊可以觀察到，光是一台 EC2 Instance 就用了 30 個 IP。</p><p>神奇&mldr; 接著再來看一下 EKS NodeGroup 是如何得到 IP 吧<style>div.dot-separator{margin:3rem;text-align:center;font-weight:700;font-size:16px}span.dot{&:before { content:"\2022 \00a0\00a0\00a0 \2022 \00a0\00a0\00a0 \2022"; font-size:1.5rem; }}</style><div class=dot-separator><span class=dot></span></div></p><h2 id=eks-nodegroup-ip-配發流程>EKS NodeGroup IP 配發流程</h2><p>預設 AWS EKS 使用的 CNI 是官方的 Add-ons <a href=https://docs.aws.amazon.com/eks/latest/userguide/managing-vpc-cni.html target=_blank rel="noopener noreffer">Amazon VPC CNI</a> ，供裝 EKS 時會自動套用。</p><p>Amazon VPC CNI 中有兩個元件[1]</p><ul><li>CNI Binary</li><li>ipamd</li></ul><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>IP Address Management (IPAM) daemon<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>ipamd 的全名是 IP Address Management (IPAM) daemon，負責 IP 的配發。</div></div></div><p>每次 Node Group 建出新的 EC2 Instance，預設會在所屬 Subnet 中綁定一個 <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html target=_blank rel="noopener noreffer">ENI</a>，ipamd 會負責在主 ENI 配發一定數量的 IP slot 用來卡位，這些 ENI 上的空位就是 <code>warm pool</code>，等著後續的 IP 配發。 (<code>warm</code> 的概念後面會持續提到，其實就是預配發的意思)</p><p>當主 ENI 的 IP slot 都被填入 IP，ipamd 會再綁定新的 ENI 。此時 ipamd 也同樣會配發 <code>warm pool</code> 給 Secondary ENI。</p><p>依此類推，隨著 Pod 的數量越多，ENI 的 pool 一直被塞滿，ipamd 不斷地配新的 ENI ，直到 EC2 Instance 不能再綁定更多 ENI 為止。</p><p>至於一個 Instance 能綁多少個 ENI、一個 ENI 能綁多少個 IP，則是由 instance type 決定[2]。</p><p><figure><a class=lightgallery href=https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image.png title="IP 配發流程" data-thumbnail=https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image.png data-sub-html="<h2>IP 配發流程</h2><p>IP 配發流程</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image.png data-srcset="https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image.png, https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image.png 1.5x, https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image.png 2x" data-sizes=auto alt=https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/image.png></a><figcaption class=image-caption>IP 配發流程</figcaption></figure></p><br><h2 id=warm-pool-數量對於-eks-的影響>WARM POOL 數量對於 EKS 的影響</h2><p>在符合 EC2 Instance 規格的限制之下，<code>warm pool</code> 數量是可以被調整的，使用者可在 <code>aws-node</code> daemonset 中，藉由調整環境變數 <code>WARM_ENI_TARGET</code>、<code>WARM_IP_TARGET</code>、<code>MINIMUM_IP_TARGET</code> 來設定。</p><h3 id=warm_eni_target-除了主-eni要額外預綁定的-eni-數量>WARM_ENI_TARGET: 除了主 ENI，要額外預綁定的 ENI 數量</h3><p>情境: 我的 Instance 綁定了 2 個 ENI，每個 ENI 各支援 5 個 IP
若 Node 已經用了 5 個 IP，此情況下表示有一個 ENI 已滿，另一個 ENI 還是 <code>warm</code> 的狀態。</p><p>這時若有新 Pod 被分配到這個 Node ，要配發的新 IP 會被塞到第二個 ENI 的空 slot 中，這時候就沒有任何 <code>warm</code> ENI 了，</p><p>ipamd 就會綁定 <code>WARM_ENI_TARGET</code> 個 ENI 作為備用。</p><h3 id=warm_ip_target-eni-中warm-pool-的-ip-數量>WARM_IP_TARGET: ENI 中，warm pool 的 IP 數量</h3><p>情境: 我的 Instance 綁定 1 個 ENI，支援 20 個 IP，且 WARM_ENI_TARGET=0</p><p>在 WARM_IP_TARGET=5 的情況下，當這個 Node 開始要求第 16 個 IP ，這時表示 <code>warm</code> IP 數量已經小於 5 ，ipamd 會即時呼叫 EC2 API 要求一個新的 ENI。</p><p>待新的 ENI 綁定後，會得到一個具有 20 個空位的 <code>warm</code> ENI，一直到下次<code>warm</code> ip 不夠，才會再次要求新 ENI。</p><h3 id=minimum_ip_target-eni-要分配的最少-ip-數>MINIMUM_IP_TARGET: ENI 要分配的最少 IP 數</h3><p>情境: 我的 Instance 綁定 1 個 ENI，支援 10 個 IP
若 MINIMUM_IP_TARGET=100，ipamd 會立刻綁定 9 個 warm ENI (加上原本的 1 個 ENI，這樣 IP 空位才足夠 100)</p><style>div.dot-separator{margin:3rem;text-align:center;font-weight:700;font-size:16px}span.dot{&:before { content:"\2022 \00a0\00a0\00a0 \2022 \00a0\00a0\00a0 \2022"; font-size:1.5rem; }}</style><div class=dot-separator><span class=dot></span></div><h2 id=結論>結論</h2><p>EKS 中，Pod 也會佔用 ENI 的 IP，在規劃 Subnet 大小的時候需特別注意</p><p>如果 EKS 在一個小的 subnet 中供裝，IP 有限，則可透過調整 <code>WARM_IP_TARGET</code> 和 <code>MINIMUM_IP_TARGET</code>，確保 Node 有足夠 IP 可用。</p><p><br>調整設定前，必須先估計好扣除其他服務，整個 Subnet 有多少剩餘 IP 以及大概每個 Node 會執行多少 Pods，可以透過這個 <a href=https://aws.github.io/aws-eks-best-practices/networking/subnet-calc/subnet-calc.xlsx target=_blank rel="noopener noreffer">IP 計算機</a>，它能根據 EKS Instance type 和 Pods 數量等，估計出 EKS IP 使用情況。</p><p>當然這是以一個 Subnet 估算，若 EKS 供裝在多 AZ 架構，可以再自行推估一下。</p><p><br>整體調整的方向大概是這樣:</p><p>先查詢 instance type ，得知 ENI 和 IP 數量。以 m5a.xlarge 為例，它支援 4 個 ENI ，各 15 個 IP。</p><p>如果估計出的 Pod 數不會這麼多，可以將 <code>MINIMUM_IP_TARGET</code> 調小，讓它不要預先配好 15 個 IP</p><p>但 <code>MINIMUM_IP_TARGET</code> 必須大於估計的 Pods 數就是了，否則沒有意義</p><br><h2 id=參考資料>參考資料</h2><p>[1] <a href=https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/ target=_blank rel="noopener noreffer">https://aws.github.io/aws-eks-best-practices/networking/vpc-cni/</a></p><p>[2] <a href=https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/eni-and-ip-target.md target=_blank rel="noopener noreffer">https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/eni-and-ip-target.md</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新於 2023-05-24</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://droyuki.github.io/2023/05/eks-nodegroup-ip-allocation/ data-title="EKS Nodegroup IP 的配發原理" data-hashtags=aws,eks,k8s><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://droyuki.github.io/2023/05/eks-nodegroup-ip-allocation/ data-hashtag=aws><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://droyuki.github.io/2023/05/eks-nodegroup-ip-allocation/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/aws/>aws</a>,&nbsp;<a href=/tags/eks/>eks</a>,&nbsp;<a href=/tags/k8s/>k8s</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主頁</a></span></section></div><div class=post-nav><a href=/2023/05/ip-calculator/ class=prev rel=prev title="IP Calculator"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>IP Calculator</a>
<a href=/2023/06/eks-nodegroup-in-private-snet/ class=next rel=next title="透過 Pod SNAT 節省 EKS IP 資源">透過 Pod SNAT 節省 EKS IP 資源<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>weichen</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到頂部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看評論><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"複製到剪貼板",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"💬",lightTheme:"github-light",repo:"droyuki/droyuki.github.io"}},lightgallery:!0,search:{algoliaAppID:"",algoliaIndex:"algolia_index",algoliaSearchKey:"algolia_search_only_key",highlightTag:"em",maxResultLength:10,noResultsFound:"沒有找到結果",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4FB17VHDQ7",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4FB17VHDQ7" async></script></body></html>